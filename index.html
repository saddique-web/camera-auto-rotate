<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Camera Capture â€” Auto Rotate & Toggle</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, Arial; padding: 1rem; background:#f8f9fa; }
    h1 { font-size:1.25rem; margin-bottom:1rem; }
    .controls { margin-bottom: 1rem; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    video, canvas { border: 1px solid #ccc; border-radius:10px; max-width:100%; height:auto; display:block; margin:auto; }
    button { padding:.45rem .9rem; border:none; border-radius:6px; cursor:pointer; }
    button.primary { background:#0d6efd; color:white; }
    button.success { background:#198754; color:white; }
    button.danger { background:#dc3545; color:white; }
    .note { color:#555; font-size:0.9rem; margin-top:0.5rem; text-align:center; }
  </style>
</head>
<body>
<h1 class="text-center">Auto Rotate Camera Capture</h1>

<div class="controls" style="justify-content:center;">
  <button id="cameraBtn" class="primary">Take</button>
  <input type="hidden" id="captured_image">
</div>

<video id="video" playsinline autoplay muted style="display:none"></video>
<canvas id="canvas" style="display:none"></canvas>

<div class="note">
  - Click <b>Take</b> to start your camera.<br>
  - Works with back camera and auto-rotates for portrait or landscape.
</div>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const btn = document.getElementById("cameraBtn");
  const hiddenInput = document.getElementById("captured_image");
  let stream = null;
  let state = "idle";

  // Helper: Get device rotation angle (0,90,180,270)
  function getDisplayRotation() {
    if (screen?.orientation?.angle !== undefined) return screen.orientation.angle;
    if (typeof window.orientation === "number") return (window.orientation + 360) % 360;
    return 0;
  }

  // Start back camera
  async function startCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },  // use back camera on mobile
      audio: false
    });
    video.srcObject = stream;
    video.style.display = "block";
    canvas.style.display = "none";
  }

  // Capture frame and auto rotate
  function capturePhoto() {
    if (!video.videoWidth) return;

    const vw = video.videoWidth;
    const vh = video.videoHeight;
    const rotation = getDisplayRotation();
    const rotated = (rotation === 90 || rotation === 270);

    canvas.width = rotated ? vh : vw;
    canvas.height = rotated ? vw : vh;

    const ctx = canvas.getContext("2d");
    ctx.save();

    switch (rotation) {
      case 90:
        ctx.translate(canvas.width, 0);
        ctx.rotate(0.5 * Math.PI);
        ctx.drawImage(video, 0, 0, vw, vh);
        break;
      case 180:
        ctx.translate(canvas.width, canvas.height);
        ctx.rotate(Math.PI);
        ctx.drawImage(video, 0, 0, vw, vh);
        break;
      case 270:
        ctx.translate(0, canvas.height);
        ctx.rotate(-0.5 * Math.PI);
        ctx.drawImage(video, 0, 0, vw, vh);
        break;
      default:
        ctx.drawImage(video, 0, 0, vw, vh);
    }

    ctx.restore();
    canvas.style.display = "block";
    hiddenInput.value = canvas.toDataURL("image/png");

    // Stop camera stream
    if (stream) stream.getTracks().forEach(t => t.stop());
    video.style.display = "none";
  }

  // Button toggle logic
  btn.addEventListener("click", async () => {
    if (state === "idle") {
      try {
        await startCamera();
        state = "streaming";
        btn.textContent = "Capture";
        btn.className = "success";
      } catch (err) {
        alert("Camera access denied: " + err.message);
      }
    } else if (state === "streaming") {
      capturePhoto();
      state = "captured";
      btn.textContent = "Remove";
      btn.className = "danger";
    } else if (state === "captured") {
      canvas.style.display = "none";
      hiddenInput.value = "";
      state = "idle";
      btn.textContent = "Take";
      btn.className = "primary";
    }
  });

  // Stop camera when leaving page
  window.addEventListener("beforeunload", () => {
    if (stream) stream.getTracks().forEach(t => t.stop());
  });
</script>
</body>
</html>
